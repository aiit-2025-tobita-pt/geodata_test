<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>東京 NDVI立体 + CO₂アニメ</title>
    <script src="https://cdn.jsdelivr.net/npm/deck.gl@8.9.26/dist.min.js"></script>
    <style>
      body { margin: 0; }
      #map { width: 100vw; height: 100vh; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const GEOJSON_URL = 'https://aiit-2025-tobita-pt.github.io/geodata_test/data/tokyo_ndvi_polygon_dummy_2023_2.geojson';
      const ICON_URL = 'https://aiit-2025-tobita-pt.github.io/geodata_test/data/co2.png';

      const iconMapping = {
        co2: { x: 0, y: 0, width: 512, height: 512, anchorY: 512, mask: false }
      };

      let scale = 1;
      let increasing = true;
      let deckgl;

      function createIconLayer(scale, co2Data) {
        return new deck.IconLayer({
          id: 'co2-icons',
          data: co2Data,
          iconAtlas: ICON_URL,
          iconMapping: iconMapping,
          getIcon: () => 'co2',
          sizeScale: scale * 0.25, // 小さめに表示（1/4）
          getPosition: d => d.position,
          getSize: () => 30, // 実サイズ
          billboard: true
        });
      }

      function animate(co2Data, tileLayer, ndviLayer) {
        scale += increasing ? 0.03 : -0.03;
        if (scale >= 2) increasing = false;
        if (scale <= 1) increasing = true;

        const iconLayer = createIconLayer(scale, co2Data);

        deckgl.setProps({
          layers: [
            tileLayer,
            ndviLayer,
            iconLayer
          ]
        });

        requestAnimationFrame(() => animate(co2Data, tileLayer, ndviLayer));
      }

      fetch(GEOJSON_URL)
        .then(res => res.json())
        .then(data => {
          const polygons = data.features;

          const ndviLayer = new deck.PolygonLayer({
            id: 'ndvi-layer',
            data: polygons,
            pickable: true,
            extruded: true,
            wireframe: false,
            filled: true,
            stroked: false,
            getPolygon: f => {
              if (f.geometry.type === 'Polygon') return f.geometry.coordinates;
              if (f.geometry.type === 'MultiPolygon') return f.geometry.coordinates[0];
              return [];
            },
            getElevation: f => f.properties.ndvi_mean * 10000,
            getFillColor: f => {
              const ndvi = f.properties.ndvi_mean;
              return [Math.floor(ndvi * 255), 200, 100, 180];
            }
          });

          const co2Data = polygons.map(f => {
            const coords = f.geometry.coordinates[0];
            const lngs = coords.map(p => p[0]);
